<div class="shipment-create-container">
  <div class="page-header">
    <h1>Create New Shipment</h1>
    <p class="subtitle">Create a shipment for an existing order</p>
  </div>

  @if (isSubmitting()) {
    <mat-card class="loading-card">
      <mat-card-content>
        <div class="loading-content">
          <mat-spinner diameter="40"></mat-spinner>
          <p>Creating shipment...</p>
        </div>
      </mat-card-content>
    </mat-card>
  } @else {
    <form [formGroup]="shipmentForm" (ngSubmit)="onSubmit()">
      <!-- Order Selection -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>shopping_cart</mat-icon>
            Order Selection
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Select Order</mat-label>
            <input
              matInput
              [formControl]="orderSearchControl"
              [matAutocomplete]="orderAuto"
              placeholder="Search by order number or customer name..."
            />
            <mat-icon matSuffix>search</mat-icon>
            <mat-autocomplete
              #orderAuto="matAutocomplete"
              [displayWith]="displayOrder"
              (optionSelected)="onOrderSelected($event.option.value)"
            >
              @if (loadingOrders()) {
                <mat-option disabled>
                  <mat-spinner diameter="20"></mat-spinner>
                  Loading orders...
                </mat-option>
              } @else {
                @for (order of filteredOrders$ | async; track order.id) {
                  <mat-option [value]="order">
                    <div class="order-option">
                      <span class="order-number">{{ order.orderNumber }}</span>
                      <span class="customer-name">{{ order.customerName }}</span>
                      <span class="order-total">{{ order.totalAmount.amount | currency:order.totalAmount.currency }}</span>
                    </div>
                  </mat-option>
                }
              }
            </mat-autocomplete>
            @if (!selectedOrder()) {
              <mat-hint>Start typing to search for an order</mat-hint>
            }
          </mat-form-field>

          @if (selectedOrder(); as order) {
            <div class="selected-order-info">
              <div class="order-detail">
                <span class="label">Order Number:</span>
                <span class="value">{{ order.orderNumber }}</span>
              </div>
              <div class="order-detail">
                <span class="label">Customer:</span>
                <span class="value">{{ order.customerName }}</span>
              </div>
              <div class="order-detail">
                <span class="label">Items:</span>
                <span class="value">{{ order.itemCount }} items</span>
              </div>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Items Selection -->
      @if (selectedOrder()) {
        <mat-card class="form-card">
          <mat-card-header>
            <mat-card-title>
              <mat-icon>inventory_2</mat-icon>
              Shipment Items
            </mat-card-title>
            <div class="card-actions">
              <button mat-button type="button" (click)="addAllItems()">
                <mat-icon>add_circle</mat-icon>
                Add All
              </button>
              <button mat-button type="button" (click)="clearAllItems()" [disabled]="selectedItems().length === 0">
                <mat-icon>remove_circle</mat-icon>
                Clear All
              </button>
            </div>
          </mat-card-header>
          <mat-card-content>
            <div class="items-grid">
              @for (detail of getOrderDetails(); track detail.id) {
                <div class="item-card" [class.selected]="isItemSelected(detail)">
                  <div class="item-info">
                    <span class="product-name">{{ detail.productName }}</span>
                    <span class="product-sku">SKU: {{ detail.productSku }}</span>
                    <span class="available-qty">Available: {{ detail.quantity }}</span>
                  </div>
                  <div class="item-actions">
                    @if (isItemSelected(detail)) {
                      <button mat-icon-button type="button" (click)="decrementItem(detail)">
                        <mat-icon>remove</mat-icon>
                      </button>
                      <span class="quantity">{{ getItemQuantity(detail) }}</span>
                      <button mat-icon-button type="button" (click)="addItem(detail)" [disabled]="getItemQuantity(detail) >= detail.quantity">
                        <mat-icon>add</mat-icon>
                      </button>
                      <button mat-icon-button type="button" color="warn" (click)="removeItem(detail.id)">
                        <mat-icon>delete</mat-icon>
                      </button>
                    } @else {
                      <button mat-raised-button type="button" color="primary" (click)="addItem(detail)">
                        <mat-icon>add</mat-icon>
                        Add
                      </button>
                    }
                  </div>
                </div>
              }
            </div>

            @if (selectedItems().length > 0) {
              <div class="selected-items-summary">
                <mat-chip-set>
                  @for (item of selectedItems(); track item.orderDetailId) {
                    <mat-chip>
                      {{ item.productName }} (x{{ item.quantity }})
                      <button matChipRemove (click)="removeItem(item.orderDetailId)">
                        <mat-icon>cancel</mat-icon>
                      </button>
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            }

            @if (selectedItems().length === 0) {
              <p class="no-items-hint">Please select at least one item to include in the shipment</p>
            }
          </mat-card-content>
        </mat-card>
      }

      <!-- Carrier Info -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>local_shipping</mat-icon>
            Carrier Information
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Carrier</mat-label>
              <mat-select formControlName="carrier">
                @for (carrier of carrierOptions; track carrier.value) {
                  <mat-option [value]="carrier.value">{{ carrier.label }}</mat-option>
                }
              </mat-select>
              @if (shipmentForm.get('carrier')?.invalid && shipmentForm.get('carrier')?.touched) {
                <mat-error>{{ getErrorMessage('carrier') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Tracking Number (Optional)</mat-label>
              <input matInput formControlName="trackingNumber" placeholder="Enter tracking number" />
              @if (shipmentForm.get('trackingNumber')?.invalid && shipmentForm.get('trackingNumber')?.touched) {
                <mat-error>{{ getErrorMessage('trackingNumber') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Origin Address -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>warehouse</mat-icon>
            Origin Address (Warehouse)
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="originStreet" placeholder="123 Warehouse Ave" />
            @if (shipmentForm.get('originStreet')?.invalid && shipmentForm.get('originStreet')?.touched) {
              <mat-error>{{ getErrorMessage('originStreet') }}</mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>City</mat-label>
              <input matInput formControlName="originCity" />
              @if (shipmentForm.get('originCity')?.invalid && shipmentForm.get('originCity')?.touched) {
                <mat-error>{{ getErrorMessage('originCity') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>State</mat-label>
              <input matInput formControlName="originState" />
              @if (shipmentForm.get('originState')?.invalid && shipmentForm.get('originState')?.touched) {
                <mat-error>{{ getErrorMessage('originState') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Postal Code</mat-label>
              <input matInput formControlName="originPostalCode" />
              @if (shipmentForm.get('originPostalCode')?.invalid && shipmentForm.get('originPostalCode')?.touched) {
                <mat-error>{{ getErrorMessage('originPostalCode') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Country</mat-label>
              <input matInput formControlName="originCountry" />
              @if (shipmentForm.get('originCountry')?.invalid && shipmentForm.get('originCountry')?.touched) {
                <mat-error>{{ getErrorMessage('originCountry') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Destination Address -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>home</mat-icon>
            Destination Address
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Street Address</mat-label>
            <input matInput formControlName="destinationStreet" />
            @if (shipmentForm.get('destinationStreet')?.invalid && shipmentForm.get('destinationStreet')?.touched) {
              <mat-error>{{ getErrorMessage('destinationStreet') }}</mat-error>
            }
          </mat-form-field>

          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>City</mat-label>
              <input matInput formControlName="destinationCity" />
              @if (shipmentForm.get('destinationCity')?.invalid && shipmentForm.get('destinationCity')?.touched) {
                <mat-error>{{ getErrorMessage('destinationCity') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>State</mat-label>
              <input matInput formControlName="destinationState" />
              @if (shipmentForm.get('destinationState')?.invalid && shipmentForm.get('destinationState')?.touched) {
                <mat-error>{{ getErrorMessage('destinationState') }}</mat-error>
              }
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Postal Code</mat-label>
              <input matInput formControlName="destinationPostalCode" />
              @if (shipmentForm.get('destinationPostalCode')?.invalid && shipmentForm.get('destinationPostalCode')?.touched) {
                <mat-error>{{ getErrorMessage('destinationPostalCode') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Country</mat-label>
              <input matInput formControlName="destinationCountry" />
              @if (shipmentForm.get('destinationCountry')?.invalid && shipmentForm.get('destinationCountry')?.touched) {
                <mat-error>{{ getErrorMessage('destinationCountry') }}</mat-error>
              }
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Package Details -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>scale</mat-icon>
            Package Details
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-2">
              <mat-label>Weight</mat-label>
              <input matInput type="number" formControlName="weight" min="0" step="0.1" />
              @if (shipmentForm.get('weight')?.invalid && shipmentForm.get('weight')?.touched) {
                <mat-error>{{ getErrorMessage('weight') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Unit</mat-label>
              <mat-select formControlName="weightUnit">
                @for (unit of weightUnitOptions; track unit.value) {
                  <mat-option [value]="unit.value">{{ unit.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Length</mat-label>
              <input matInput type="number" formControlName="length" min="0" step="0.1" />
              @if (shipmentForm.get('length')?.invalid && shipmentForm.get('length')?.touched) {
                <mat-error>{{ getErrorMessage('length') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Width</mat-label>
              <input matInput type="number" formControlName="width" min="0" step="0.1" />
              @if (shipmentForm.get('width')?.invalid && shipmentForm.get('width')?.touched) {
                <mat-error>{{ getErrorMessage('width') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Height</mat-label>
              <input matInput type="number" formControlName="height" min="0" step="0.1" />
              @if (shipmentForm.get('height')?.invalid && shipmentForm.get('height')?.touched) {
                <mat-error>{{ getErrorMessage('height') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Unit</mat-label>
              <mat-select formControlName="dimensionUnit">
                @for (unit of dimensionUnitOptions; track unit.value) {
                  <mat-option [value]="unit.value">{{ unit.label }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Shipping Cost & Delivery -->
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>
            <mat-icon>payments</mat-icon>
            Cost & Delivery
          </mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline" class="flex-2">
              <mat-label>Shipping Cost</mat-label>
              <mat-icon matPrefix>attach_money</mat-icon>
              <input matInput type="number" formControlName="shippingCost" min="0" step="0.01" />
              @if (shipmentForm.get('shippingCost')?.invalid && shipmentForm.get('shippingCost')?.touched) {
                <mat-error>{{ getErrorMessage('shippingCost') }}</mat-error>
              }
            </mat-form-field>

            <mat-form-field appearance="outline" class="flex-1">
              <mat-label>Currency</mat-label>
              <mat-select formControlName="currency">
                @for (curr of currencies; track curr) {
                  <mat-option [value]="curr">{{ curr }}</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Estimated Delivery Date</mat-label>
            <input matInput [matDatepicker]="deliveryPicker" formControlName="estimatedDeliveryDate" />
            <mat-datepicker-toggle matIconSuffix [for]="deliveryPicker"></mat-datepicker-toggle>
            <mat-datepicker #deliveryPicker></mat-datepicker>
            <mat-hint>Optional - leave empty if unknown</mat-hint>
          </mat-form-field>
        </mat-card-content>
      </mat-card>

      <!-- Form Actions -->
      <div class="form-actions">
        <button mat-button type="button" (click)="onCancel()">
          Cancel
        </button>
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="!selectedOrder() || selectedItems().length === 0"
        >
          <mat-icon>local_shipping</mat-icon>
          Create Shipment
        </button>
      </div>
    </form>
  }
</div>
