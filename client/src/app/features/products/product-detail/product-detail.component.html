<div class="product-detail-page">
  @if (loading()) {
    <div class="loading-container">
      <mat-progress-spinner mode="indeterminate" diameter="48"></mat-progress-spinner>
    </div>
  } @else if (product()) {
    <!-- Page Header -->
    <div class="page-header">
      <div class="header-left">
        <button mat-icon-button (click)="goBack()" class="back-button">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="header-content">
          <h1 class="page-title">{{ product()!.name }}</h1>
          <p class="page-subtitle">SKU: {{ product()!.sku }}</p>
        </div>
      </div>
      <div class="header-badges">
        <app-status-badge
          [label]="getActiveStatus().label"
          [variant]="getActiveStatus().variant"
        ></app-status-badge>
        <app-status-badge
          [label]="getStockStatus().label"
          [variant]="getStockStatus().variant"
        ></app-status-badge>
      </div>
    </div>

    <div class="detail-grid">
      <!-- Product Image -->
      <mat-card class="detail-card image-card">
        <mat-card-content>
          @if (getPrimaryImage()) {
            <img [src]="getPrimaryImage()" [alt]="product()!.name" class="product-image" />
          } @else {
            <div class="no-image">
              <mat-icon>image</mat-icon>
              <span>No image available</span>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Product Information -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>inventory_2</mat-icon>
          <mat-card-title>Product Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-row">
            <span class="info-label">SKU</span>
            <span class="info-value mono">{{ product()!.sku }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Price</span>
            <span class="info-value price">{{ product()!.price.amount | currency:product()!.price.currency }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Status</span>
            <span class="info-value">
              <app-status-badge
                [label]="getActiveStatus().label"
                [variant]="getActiveStatus().variant"
              ></app-status-badge>
            </span>
          </div>
          @if (product()!.description) {
            <div class="info-row description">
              <span class="info-label">Description</span>
              <span class="info-value">{{ product()!.description }}</span>
            </div>
          }
        </mat-card-content>
      </mat-card>

      <!-- Stock Information -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>warehouse</mat-icon>
          <mat-card-title>Stock Information</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-row">
            <span class="info-label">Current Stock</span>
            <span class="info-value" [class.warning]="product()!.isLowStock" [class.error]="product()!.stockQuantity === 0">
              {{ product()!.stockQuantity }} units
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Low Stock Threshold</span>
            <span class="info-value">{{ product()!.lowStockThreshold }} units</span>
          </div>
          <div class="info-row">
            <span class="info-label">Stock Status</span>
            <span class="info-value">
              <app-status-badge
                [label]="getStockStatus().label"
                [variant]="getStockStatus().variant"
              ></app-status-badge>
            </span>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Timeline -->
      <mat-card class="detail-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>schedule</mat-icon>
          <mat-card-title>Timeline</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="info-row">
            <span class="info-label">Created</span>
            <span class="info-value">{{ product()!.createdAt | date:'MMM d, y, h:mm a' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Last Updated</span>
            <span class="info-value">{{ product()!.updatedAt | date:'MMM d, y, h:mm a' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Created By</span>
            <span class="info-value">{{ product()!.createdBy }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Modified By</span>
            <span class="info-value">{{ product()!.modifiedBy }}</span>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Product Details/Attributes -->
    @if (product()!.details && product()!.details.length > 0) {
      <mat-card class="details-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>list_alt</mat-icon>
          <mat-card-title>Product Attributes</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="product()!.details" class="details-table">
            <ng-container matColumnDef="key">
              <th mat-header-cell *matHeaderCellDef>Attribute</th>
              <td mat-cell *matCellDef="let detail">{{ detail.key }}</td>
            </ng-container>

            <ng-container matColumnDef="value">
              <th mat-header-cell *matHeaderCellDef>Value</th>
              <td mat-cell *matCellDef="let detail">{{ detail.value }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    }

    <!-- Product Images Gallery -->
    @if (product()!.images && product()!.images.length > 1) {
      <mat-card class="gallery-card">
        <mat-card-header>
          <mat-icon mat-card-avatar>collections</mat-icon>
          <mat-card-title>Product Images</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="image-gallery">
            @for (image of product()!.images; track image.id) {
              <div class="gallery-item" [class.primary]="image.isPrimary">
                <img [src]="image.url" [alt]="image.altText || product()!.name" />
                @if (image.isPrimary) {
                  <span class="primary-badge">Primary</span>
                }
              </div>
            }
          </div>
        </mat-card-content>
      </mat-card>
    }

    <!-- Actions -->
    <div class="actions-row">
      <button mat-stroked-button (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Products
      </button>
    </div>
  } @else {
    <div class="not-found">
      <mat-icon>search_off</mat-icon>
      <h2>Product Not Found</h2>
      <p>The product you're looking for doesn't exist or has been removed.</p>
      <button mat-flat-button color="primary" (click)="goBack()">Back to Products</button>
    </div>
  }
</div>
